import { connect } from 'cloudflare:sockets';

// Basic configuration values remain unobfuscated for easy updates
let proxyIP = '210.61.97.241:81';  // proxyIP
let yourUUID = '93bf61d9-3796-44c2-9b3a-49210ece2585';  // UUID
let cfip = [ // 格式:优选域名:端口#备注名称、优选IP:端口#备注名称、[ipv6优选]:端口#备注名称、优选域名#备注
    'mfa.gov.ua#SG', 'saas.sin.fan#HK', 'store.ubi.com#JP','cf.130519.xyz#KR','cf.008500.xyz#HK',
    'cf.090227.xyz#SG', 'cf.877774.xyz#HK','cdns.doon.eu.org#JP','sub.danfeng.eu.org#TW','cf.zhetengsha.eu.org#HK'
];  // 在此感谢各位大佬维护的优选域名

const __obfuscatedPayload = `ZnVuY3Rpb24gZ2V0SG9tZVBhZ2VIVE1MKGN1cnJlbnREb21haW4pIHsKICAgIHJldHVybiBgPCFET0NUWVBFIGh0bWw+PGh0bWw+PGhlYWQ+PG1ldGEgY2hhcnNldD0idXRmLTgiPjxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsaW5pdGlhbC1zY2FsZT0xIj48dGl0bGU+U25pcHBldHM8L3RpdGxlPjxzdHlsZT5ib2R5e2ZvbnQtZmFtaWx5OkFyaWFsLHNhbnMtc2VyaWY7bWFyZ2luOjA7cGFkZGluZzo0MHB4IDIwcHg7YmFja2dyb3VuZDpsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCM2NjdlZWEgMCUsIzE4ODAwZSAxMDAlKTttaW4taGVpZ2h0OjEwMHZoO2Rpc3BsYXk6ZmxleDthbGlnbi1pdGVtczpjZW50ZXI7anVzdGlmeS1jb250ZW50OmNlbnRlcn0uY29udGFpbmVye21heC13aWR0aDo2MDBweDtiYWNrZ3JvdW5kOiNmZmY7cGFkZGluZzo0MHB4O2JvcmRlci1yYWRpdXM6MTBweDtib3gtc2hhZG93OjAgMTBweCA0MHB4IHJnYmEoMCwwLDAsLjMpO3RleHQtYWxpZ246Y2VudGVyfWgxe2NvbG9yOiM2NjdlZWE7bWFyZ2luLWJvdHRvbToyMHB4fS5pbmZve2ZvbnQtc2l6ZToxOHB4O2NvbG9yOiM2NjY7bWFyZ2luOjIwcHggMH0ubGlua3tkaXNwbGF5OmlubGluZS1ibG9jaztiYWNrZ3JvdW5kOiM2NjdlZWE7Y29sb3I6I2ZmZjtwYWRkaW5nOjEycHggMzBweDtib3JkZXItcmFkaXVzOjVweDt0ZXh0LWRlY29yYXRpb246bm9uZTttYXJnaW4tdG9wOjIwcHh9Lmxpbms6aG92ZXJ7YmFja2dyb3VuZDojNTU2OGQzfS5mb290ZXJ7bWFyZ2luLXRvcDozMHB4O3BhZGRpbmctdG9wOjIwcHg7Ym9yZGVyLXRvcDoxcHggc29saWQgI2VlZTtmb250LXNpemU6MTRweDtjb2xvcjojOTk5fS5mb290ZXIgYXtjb2xvcjojNjY3ZWVhO3RleHQtZGVjb3JhdGlvbjpub25lO21hcmdpbjowIDEwcHh9LmZvb3RlciBhOmhvdmVye3RleHQtZGVjb3JhdGlvbjp1bmRlcmxpbmV9PC9zdHlsZT48L2hlYWQ+PGJvZHk+PGRpdiBjbGFzcz0iY29udGFpbmVyIj48aDE+SGVsbG8gU25pcHBldHM8L2gxPjxkaXYgY2xhc3M9ImluZm8iPuivt+iuv+mXrjogPHN0cm9uZz5odHRwczovLyR7Y3VycmVudERvbWFpbn0v5L2g55qEVVVJRDwvc3Ryb25nPjxicj48YnI+5p+l55yL6K6i6ZiF5ZKM5L2/55So6K+05piOPC9kaXY+PGRpdiBjbGFzcz0iZm9vdGVyIj48YSBocmVmPSJodHRwczovL2dpdGh1Yi5jb20vZW9vY2UvQ0YtV29ya2Vycy1hbmQtU25pcC1WTEVTUyIgdGFyZ2V0PSJfYmxhbmsiPkdpdEh1YjwvYT58PGEgaHJlZj0iaHR0cHM6Ly90Lm1lL2Vvb2NldSIgdGFyZ2V0PSJfYmxhbmsiPlRH576k57uEPC9hPjwvZGl2PjwvZGl2PjwvYm9keT48L2h0bWw+YDsKfQoKZnVuY3Rpb24gZ2V0U3ViUGFnZUhUTUwoY3VycmVudERvbWFpbikgewogICAgY29uc3QgdjJyYXlTdWJMaW5rID0gYGh0dHBzOi8vJHtjdXJyZW50RG9tYWlufS9zdWIvJHt5b3VyVVVJRH1gOwogICAgY29uc3QgY2xhc2hTdWJMaW5rID0gYGh0dHBzOi8vc3VibGluay5lb29jZS5jb20vY2xhc2g/Y29uZmlnPWh0dHBzOi8vJHtjdXJyZW50RG9tYWlufS9zdWIvJHt5b3VyVVVJRH1gOwogICAgY29uc3Qgc2luZ2JveFN1YkxpbmsgPSBgaHR0cHM6Ly9zdWJsaW5rLmVvb2NlLmNvbS9zaW5nYm94P2NvbmZpZz1odHRwczovLyR7Y3VycmVudERvbWFpbn0vc3ViLyR7eW91clVVSUR9YDsKICAgIAogICAgcmV0dXJuIGA8IURPQ1RZUEUgaHRtbD48aHRtbD48aGVhZD48bWV0YSBjaGFyc2V0PSJ1dGYtOCI+PG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCxpbml0aWFsLXNjYWxlPTEiPjx0aXRsZT7orqLpmIXpk77mjqU8L3RpdGxlPjxzdHlsZT4qe21hcmdpbjowO3BhZGRpbmc6MDtib3gtc2l6aW5nOmJvcmRlci1ib3h9Ym9keXtmb250LWZhbWlseTpBcmlhbCxzYW5zLXNlcmlmO2JhY2tncm91bmQ6bGluZWFyLWdyYWRpZW50KDEzNWRlZywjNjY3ZWVhIDAlLCMxODgwMGUgMTAwJSk7bWluLWhlaWdodDoxMDB2aDtwYWRkaW5nOjIwcHh9LmNvbnRhaW5lcnttYXgtd2lkdGg6OTAwcHg7bWFyZ2luOjAgYXV0bztiYWNrZ3JvdW5kOiNmZmY7Ym9yZGVyLXJhZGl1czoxNXB4O3BhZGRpbmc6MzBweDtib3gtc2hhZG93OjAgMjBweCA2MHB4IHJnYmEoMCwwLDAsLjMpfWgxe2NvbG9yOiM2NjdlZWE7bWFyZ2luLWJvdHRvbToxMHB4O2ZvbnQtc2l6ZToycmVtO3RleHQtYWxpZ246Y2VudGVyfS5zZWN0aW9ue21hcmdpbi1ib3R0b206MjVweH0uc2VjdGlvbi10aXRsZXtjb2xvcjojNjY3ZWVhO2ZvbnQtc2l6ZToxNnB4O2ZvbnQtd2VpZ2h0OjYwMDttYXJnaW4tYm90dG9tOjEycHg7cGFkZGluZy1ib3R0b206NnB4O2JvcmRlci1ib3R0b206MnB4IHNvbGlkICM2NjdlZWF9LmxpbmstYm94e2JhY2tncm91bmQ6I2Y3ZjlmYztib3JkZXI6MXB4IHNvbGlkICNlMWU4ZWQ7Ym9yZGVyLXJhZGl1czo4cHg7cGFkZGluZzoxMnB4O21hcmdpbi1ib3R0b206MTBweH0ubGluay1sYWJlbHtmb250LXNpemU6MTZweDtjb2xvcjojNjY2O21hcmdpbi1ib3R0b206NnB4O2ZvbnQtd2VpZ2h0OjcwMH0ubGluay1jb250ZW50e2Rpc3BsYXk6ZmxleDtnYXA6OHB4fS5saW5rLXRleHR7ZmxleDoxO2JhY2tncm91bmQ6I2ZmZjtwYWRkaW5nOjhweCAxMnB4O2JvcmRlci1yYWRpdXM6NXB4O2JvcmRlcjoxcHggc29saWQgI2RkZDtmb250LXNpemU6LjhyZW07d29yZC1icmVhazpicmVhay1hbGw7Zm9udC1mYW1pbHk6bW9ub3NwYWNlfS5jb3B5LWJ0bntiYWNrZ3JvdW5kOiM2NjdlZWE7Y29sb3I6I2ZmZjtib3JkZXI6bm9uZTtwYWRkaW5nOjhweCAxNnB4O2JvcmRlci1yYWRpdXM6NXB4O2N1cnNvcjpwb2ludGVyO2ZvbnQtc2l6ZToxM3B4O3doaXRlLXNwYWNlOm5vd3JhcH0uY29weS1idG46aG92ZXJ7YmFja2dyb3VuZDojNTU2OGQzfS5jb3B5LWJ0bi5jb3BpZWR7YmFja2dyb3VuZDojNDhjNzc0fS51c2FnZS1zZWN0aW9ue2JhY2tncm91bmQ6I2ZmZjllNjtib3JkZXItbGVmdDo0cHggc29saWQgI2ZmYzEwNztwYWRkaW5nOjE1cHg7Ym9yZGVyLXJhZGl1czo1cHg7bWFyZ2luLXRvcDoyNXB4fS51c2FnZS10aXRsZXtjb2xvcjojZjU3YzAwO2ZvbnQtc2l6ZToxLjJyZW07Zm9udC13ZWlnaHQ6NjAwO21hcmdpbi1ib3R0b206MTJweH0udXNhZ2UtaXRlbXttYXJnaW4tYm90dG9tOjEycHg7Zm9udC1zaXplOjEzcHg7bGluZS1oZWlnaHQ6MS42fS51c2FnZS1pdGVtIHN0cm9uZ3tjb2xvcjojMzMzO2Rpc3BsYXk6YmxvY2s7bWFyZ2luLWJvdHRvbTo0cHh9LnVzYWdlLWl0ZW0gY29kZXtiYWNrZ3JvdW5kOiNmZmY7cGFkZGluZzoycHggNnB4O2JvcmRlci1yYWRpdXM6M3B4O2NvbG9yOiNlOTFlNjM7Zm9udC1zaXplOjEzcHg7Ym9yZGVyOjFweCBzb2xpZCAjZGRkO3dvcmQtd3JhcDpicmVhay13b3JkO3dvcmQtYnJlYWs6YnJlYWstYWxsO2Rpc3BsYXk6aW5saW5lLWJsb2NrO21heC13aWR0aDoxMDAlfS5leGFtcGxle2NvbG9yOiM2NjY7Zm9udC1zaXplOjE0cHg7bWFyZ2luLWxlZnQ6OHB4fS5mb290ZXJ7bWFyZ2luLXRvcDozMHB4O3BhZGRpbmctdG9wOjIwcHg7Ym9yZGVyLXRvcDoxcHggc29saWQgI2UxZThlZDt0ZXh0LWFsaWduOmNlbnRlcjtmb250LXNpemU6MTRweDtjb2xvcjojOTk5fS5mb290ZXIgYXtjb2xvcjojNjY3ZWVhO3RleHQtZGVjb3JhdGlvbjpub25lO21hcmdpbjowIDEwcHh9LmZvb3RlciBhOmhvdmVye3RleHQtZGVjb3JhdGlvbjp1bmRlcmxpbmV9QG1lZGlhIChtYXgtd2lkdGg6NzY4cHgpey5jb250YWluZXJ7cGFkZGluZzoyMHB4fS5saW5rLWNvbnRlbnR7ZmxleC1kaXJlY3Rpb246Y29sdW1ufS5jb3B5LWJ0bnt3aWR0aDoxMDAlfX08L3N0eWxlPjwvaGVhZD48Ym9keT48ZGl2IGNsYXNzPSJjb250YWluZXIiPjxoMT5TbmlwcGV0cyDorqLpmIXkuK3lv4M8L2gxPjxkaXYgY2xhc3M9InNlY3Rpb24iPjxkaXYgY2xhc3M9InNlY3Rpb24tdGl0bGUiPvCflJcg6YCa55So6K6i6ZiFPC9kaXY+PGRpdiBjbGFzcz0ibGluay1ib3giPjxkaXYgY2xhc3M9ImxpbmstbGFiZWwiPnYycmF5TiAvIExvb24gLyBTaGFkb3dyb2NrZXQgLyBLYXJpbmc8L2Rpdj48ZGl2IGNsYXNzPSJsaW5rLWNvbnRlbnQiPjxkaXYgY2xhc3M9ImxpbmstdGV4dCIgaWQ9InYycmF5LWxpbmsiPiR7djJyYXlTdWJMaW5rfTwvZGl2PjxidXR0b24gY2xhc3M9ImNvcHktYnRuIiBvbmNsaWNrPSJjb3B5VG9DbGlwYm9hcmQoJ3YycmF5LWxpbmsnLHRoaXMpIj7lpI3liLY8L2J1dHRvbj48L2Rpdj48L2Rpdj48L2Rpdj48ZGl2IGNsYXNzPSJzZWN0aW9uIj48ZGl2IGNsYXNzPSJzZWN0aW9uLXRpdGxlIj7wn5i6IENsYXNoIOezu+WIl+iuoumYhTwvZGl2PjxkaXYgY2xhc3M9ImxpbmstYm94Ij48ZGl2IGNsYXNzPSJsaW5rLWxhYmVsIj5NaWhvbW8gLyBGbENsYXNoIC8gQ2xhc2ggTWV0YTwvZGl2PjxkaXYgY2xhc3M9ImxpbmstY29udGVudCI+PGRpdiBjbGFzcz0ibGluay10ZXh0IiBpZD0iY2xhc2gtbGluayI+JHtjbGFzaFN1Ykxpbmt9PC9kaXY+PGJ1dHRvbiBjbGFzcz0iY29weS1idG4iIG9uY2xpY2s9ImNvcHlUb0NsaXBib2FyZCgnY2xhc2gtbGluaycsdGhpcykiPuWkjeWItjwvYnV0dG9uPjwvZGl2PjwvZGl2PjwvZGl2PjxkaXYgY2xhc3M9InNlY3Rpb24iPjxkaXYgY2xhc3M9InNlY3Rpb24tdGl0bGUiPvCfk6YgU2luZy1ib3gg57O75YiX6K6i6ZiFPC9kaXY+PGRpdiBjbGFzcz0ibGluay1ib3giPjxkaXYgY2xhc3M9ImxpbmstbGFiZWwiPlNpbmctYm94IC8gU0ZJIC8gU0ZBPC9kaXY+PGRpdiBjbGFzcz0ibGluay1jb250ZW50Ij48ZGl2IGNsYXNzPSJsaW5rLXRleHQiIGlkPSJzaW5nYm94LWxpbmsiPiR7c2luZ2JveFN1Ykxpbmt9PC9kaXY+PGJ1dHRvbiBjbGFzcz0iY29weS1idG4iIG9uY2xpY2s9ImNvcHlUb0NsaXBib2FyZCgnc2luZ2JveC1saW5rJyx0aGlzKSI+5aSN5Yi2PC9idXR0b24+PC9kaXY+PC9kaXY+PC9kaXY+PGRpdiBjbGFzcz0idXNhZ2Utc2VjdGlvbiI+PGRpdiBjbGFzcz0idXNhZ2UtdGl0bGUiPuKame+4jyDoh6rlrprkuYnot6/lvoQo6IqC54K56YeM55qEcGF0aCnkvb/nlKjor7TmmI48L2Rpdj48ZGl2IGNsYXNzPSJ1c2FnZS1pdGVtIj48c3Ryb25nPjEuIOm7mOiupOi3r+W+hDwvc3Ryb25nPjxjb2RlPi8/ZWQ9MjU2MDwvY29kZT48ZGl2IGNsYXNzPSJleGFtcGxlIj7kvb/nlKjku6PnoIHph4zorr7nva7nmoTpu5jorqRwcm94eWlwPC9kaXY+PC9kaXY+PGRpdiBjbGFzcz0idXNhZ2UtaXRlbSI+PHN0cm9uZz4yLiDluKbnq6/lj6PnmoRwcm94eWlwPC9zdHJvbmc+PGNvZGU+L3Byb3h5aXA9MjEwLjYxLjk3LjI0MTo4MTwvY29kZT48YnI+PGNvZGU+L3Byb3h5aXA9cHJveHkueHh4eHh4eHgudGs6NTAwMDE8L2NvZGU+PGJyPjxjb2RlPi8/ZWQ9MjU2MCZwcm94eWlwPTIxMC42MS45Ny4yNDE6ODE8L2NvZGU+PGJyPjxjb2RlPi8/ZWQ9MjU2MCZwcm94eWlwPXByb3h5Lnh4eHh4eHh4LnRrOjUwMDAxPC9jb2RlPjwvZGl2PjxkaXYgY2xhc3M9InVzYWdlLWl0ZW0iPjxzdHJvbmc+My4g5Z+f5ZCNcHJveHlpcDwvc3Ryb25nPjxjb2RlPi9wcm94eWlwPWpwLnl1dGlhbi5ueWMubW48L2NvZGU+PGJyPjxjb2RlPi8/ZWQ9MjU2MCZwcm94eWlwPWpwLnl1dGlhbi5ueWMubW48L2NvZGU+PC9kaXY+PGRpdiBjbGFzcz0idXNhZ2UtaXRlbSI+PHN0cm9uZz40LiDlhajlsYBTT0NLUzU8L3N0cm9uZz48Y29kZT4vcHJveHlpcD1zb2NrczovL3VzZXI6cGFzc3dvcmRAaG9zdDpwb3J0PC9jb2RlPjxicj48Y29kZT4vcHJveHlpcD1zb2NrczU6Ly91c2VyOnBhc3N3b3JkQGhvc3Q6cG9ydDwvY29kZT48YnI+PGNvZGU+Lz9lZD0yNTYwJnByb3h5aXA9c29ja3M6Ly91c2VyOnBhc3N3b3JkQGhvc3Q6cG9ydDwvY29kZT48YnI+PGNvZGU+Lz9lZD0yNTYwJnByb3h5aXA9c29ja3M1Oi8vdXNlcjpwYXNzd29yZEBob3N0OnBvcnQ8L2NvZGU+PC9kaXY+PGRpdiBjbGFzcz0idXNhZ2UtaXRlbSI+PHN0cm9uZz41LiDlhajlsYBIVFRQL0hUVFBTPC9zdHJvbmc+PGNvZGU+L3Byb3h5aXA9aHR0cDovL3VzZXI6cGFzc3dvcmRAaG9zdDpwb3J0PC9jb2RlPjxicj48Y29kZT4vcHJveHlpcD1odHRwczovL3VzZXI6cGFzc3dvcmRAaG9zdDpwb3J0PC9jb2RlPjxicj48Y29kZT4vP2VkPTI1NjAmcHJveHlpcD1odHRwOi8vdXNlcjpwYXNzd29yZEBob3N0OnBvcnQ8L2NvZGU+PGJyPjxjb2RlPi8/ZWQ9MjU2MCZwcm94eWlwPWh0dHBzOi8vdXNlcjpwYXNzd29yZEBob3N0OnBvcnQ8L2NvZGU+PC9kaXY+PC9kaXY+PGRpdiBjbGFzcz0iZm9vdGVyIj48YSBocmVmPSJodHRwczovL2dpdGh1Yi5jb20vZW9vY2UvQ0YtV29ya2Vycy1hbmQtU25pcC1WTEVTUyIgdGFyZ2V0PSJfYmxhbmsiPkdpdEh1YiDpobnnm648L2E+fDxhIGhyZWY9Imh0dHBzOi8vdC5tZS9lb29jZXUiIHRhcmdldD0iX2JsYW5rIj5UZWxlZ3JhbSDnvqTnu4Q8L2E+fDxhIGhyZWY9Imh0dHBzOi8vY2hlY2stcHJveHlpcC5zc3NzLm55Yy5tbiIgdGFyZ2V0PSJfYmxhbmsiPlByb3h5SVAg5qOA5rWL5pyN5YqhPC9hPjwvZGl2PjwvZGl2PjxzY3JpcHQ+ZnVuY3Rpb24gY29weVRvQ2xpcGJvYXJkKGUsdCl7Y29uc3Qgbj1kb2N1bWVudC5nZXRFbGVtZW50QnlJZChlKS50ZXh0Q29udGVudDtuYXZpZ2F0b3IuY2xpcGJvYXJkJiZuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dD9uYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dChuKS50aGVuKCgpPT57c2hvd0NvcHlTdWNjZXNzKHQpfSkuY2F0Y2goKCk9PntmYWxsYmFja0NvcHkobix0KX0pOmZhbGxiYWNrQ29weShuLHQpfWZ1bmN0aW9uIGZhbGxiYWNrQ29weShlLHQpe2NvbnN0IG49ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGV4dGFyZWEiKTtuLnZhbHVlPWUsbi5zdHlsZS5wb3NpdGlvbj0iZml4ZWQiLG4uc3R5bGUubGVmdD0iLTk5OTk5OXB4Iixkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKG4pLG4uc2VsZWN0KCk7dHJ5e2RvY3VtZW50LmV4ZWNDb21tYW5kKCJjb3B5Iiksc2hvd0NvcHlTdWNjZXNzKHQpfWNhdGNoKGUpe2FsZXJ0KCLlpI3liLblpLHotKXvvIzor7fmiYvliqjlpI3liLYiKX1kb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKG4pfWZ1bmN0aW9uIHNob3dDb3B5U3VjY2VzcyhlKXtjb25zdCB0PWUudGV4dENvbnRlbnQ7ZS50ZXh0Q29udGVudD0i5bey5aSN5Yi2IixlLmNsYXNzTGlzdC5hZGQoImNvcGllZCIpLHNldFRpbWVvdXQoKCk9PntlLnRleHRDb250ZW50PXQsZS5jbGFzc0xpc3QucmVtb3ZlKCJjb3BpZWQiKX0sMmUzKX08L3NjcmlwdD48L2JvZHk+PC9odG1sPmA7Cn0KCmFzeW5jIGZ1bmN0aW9uIGhhbmRsZUhvbWVQYWdlKHJlcXVlc3QpIHsKICAgIGNvbnN0IHVybCA9IG5ldyBVUkwocmVxdWVzdC51cmwpOwogICAgY29uc3QgY3VycmVudERvbWFpbiA9IHVybC5ob3N0bmFtZTsKICAgIHJldHVybiBuZXcgUmVzcG9uc2UoZ2V0SG9tZVBhZ2VIVE1MKGN1cnJlbnREb21haW4pLCB7CiAgICAgICAgaGVhZGVyczogeyAKICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICd0ZXh0L2h0bWw7IGNoYXJzZXQ9dXRmLTgnLAogICAgICAgICAgICAnQ2FjaGUtQ29udHJvbCc6ICduby1zdG9yZSwgbm8tY2FjaGUsIG11c3QtcmV2YWxpZGF0ZSwgbWF4LWFnZT0wJywKICAgICAgICB9LAogICAgfSk7Cn0KCmFzeW5jIGZ1bmN0aW9uIGhhbmRsZVN1YnRpb25QYWdlKHJlcXVlc3QpIHsKICAgIGNvbnN0IHVybCA9IG5ldyBVUkwocmVxdWVzdC51cmwpOwogICAgY29uc3QgY3VycmVudERvbWFpbiA9IHVybC5ob3N0bmFtZTsKICAgIHJldHVybiBuZXcgUmVzcG9uc2UoZ2V0U3ViUGFnZUhUTUwoY3VycmVudERvbWFpbiksIHsKICAgICAgICBoZWFkZXJzOiB7IAogICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ3RleHQvaHRtbDsgY2hhcnNldD11dGYtOCcsCiAgICAgICAgICAgICdDYWNoZS1Db250cm9sJzogJ25vLXN0b3JlLCBuby1jYWNoZSwgbXVzdC1yZXZhbGlkYXRlLCBtYXgtYWdlPTAnLAogICAgICAgIH0sCiAgICB9KTsKfQoKZnVuY3Rpb24gZm9ybWF0SWRlbnRpZmllcihhcnIsIG9mZnNldCA9IDApIHsKICAgIGNvbnN0IGhleCA9IFsuLi5hcnIuc2xpY2Uob2Zmc2V0LCBvZmZzZXQgKyAxNildLm1hcChiID0+IGIudG9TdHJpbmcoMTYpLnBhZFN0YXJ0KDIsICcwJykpLmpvaW4oJycpOwogICAgcmV0dXJuIGAke2hleC5zdWJzdHJpbmcoMCw4KX0tJHtoZXguc3Vic3RyaW5nKDgsMTIpfS0ke2hleC5zdWJzdHJpbmcoMTIsMTYpfS0ke2hleC5zdWJzdHJpbmcoMTYsMjApfS0ke2hleC5zdWJzdHJpbmcoMjApfWA7Cn0KCmZ1bmN0aW9uIGJhc2U2NFRvQXJyYXkoYjY0U3RyKSB7CiAgICBpZiAoIWI2NFN0cikgcmV0dXJuIHsgZXJyb3I6IG51bGwgfTsKICAgIHRyeSB7IAogICAgICAgIGNvbnN0IGJpbmFyeVN0cmluZyA9IGF0b2IoYjY0U3RyLnJlcGxhY2UoLy0vZywgJysnKS5yZXBsYWNlKC9fL2csICcvJykpOwogICAgICAgIGNvbnN0IGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkoYmluYXJ5U3RyaW5nLmxlbmd0aCk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBiaW5hcnlTdHJpbmcubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgYnl0ZXNbaV0gPSBiaW5hcnlTdHJpbmcuY2hhckNvZGVBdChpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsgZWFybHlEYXRhOiBieXRlcy5idWZmZXIsIGVycm9yOiBudWxsIH07IAogICAgfSBjYXRjaCAoZXJyb3IpIHsgCiAgICAgICAgcmV0dXJuIHsgZXJyb3IgfTsgCiAgICB9Cn0KCmZ1bmN0aW9uIGNsb3NlU29ja2V0UXVpZXRseShzb2NrZXQpIHsgCiAgICB0cnkgeyAKICAgICAgICBpZiAoc29ja2V0LnJlYWR5U3RhdGUgPT09IFdlYlNvY2tldC5PUEVOIHx8IHNvY2tldC5yZWFkeVN0YXRlID09PSBXZWJTb2NrZXQuQ0xPU0lORykgewogICAgICAgICAgICBzb2NrZXQuY2xvc2UoKTsgCiAgICAgICAgfQogICAgfSBjYXRjaCAoZXJyb3IpIHt9IAp9CgpmdW5jdGlvbiBpc1NwZWVkVGVzdFNpdGUoaG9zdG5hbWUpIHsKICAgIGNvbnN0IHNwZWVkVGVzdERvbWFpbnMgPSBbJ3NwZWVkdGVzdC5uZXQnLCdmYXN0LmNvbScsJ3NwZWVkdGVzdC5jbicsJ3NwZWVkLmNsb3VkZmxhcmUuY29tJywnb3ZvLnNwZWVkdGVzdGN1c3RvbS5jb20nXTsKICAgIGlmIChzcGVlZFRlc3REb21haW5zLmluY2x1ZGVzKGhvc3RuYW1lKSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgZm9yIChjb25zdCBkb21haW4gb2Ygc3BlZWRUZXN0RG9tYWlucykgewogICAgICAgIGlmIChob3N0bmFtZS5lbmRzV2l0aCgnLicgKyBkb21haW4pIHx8IGhvc3RuYW1lID09PSBkb21haW4pIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBwYXJzZVByb3h5QWRkcmVzcyhwcm94eVN0cikgewogICAgaWYgKCFwcm94eVN0cikgcmV0dXJuIG51bGw7CiAgICBwcm94eVN0ciA9IHByb3h5U3RyLnRyaW0oKTsKICAgIGlmIChwcm94eVN0ci5zdGFydHNXaXRoKCdzb2NrczovLycpIHx8IHByb3h5U3RyLnN0YXJ0c1dpdGgoJ3NvY2tzNTovLycpKSB7CiAgICAgICAgY29uc3QgdXJsU3RyID0gcHJveHlTdHIucmVwbGFjZSgvXnNvY2tzOlwvXC8vLCAnc29ja3M1Oi8vJyk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgdXJsID0gbmV3IFVSTCh1cmxTdHIpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdHlwZTogJ3NvY2tzNScsCiAgICAgICAgICAgICAgICBob3N0OiB1cmwuaG9zdG5hbWUsCiAgICAgICAgICAgICAgICBwb3J0OiBwYXJzZUludCh1cmwucG9ydCkgfHwgMTA4MCwKICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB1cmwudXNlcm5hbWUgPyBkZWNvZGVVUklDb21wb25lbnQodXJsLnVzZXJuYW1lKSA6ICcnLAogICAgICAgICAgICAgICAgcGFzc3dvcmQ6IHVybC5wYXNzd29yZCA/IGRlY29kZVVSSUNvbXBvbmVudCh1cmwucGFzc3dvcmQpIDogJycKICAgICAgICAgICAgfTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgIH0KICAgIAogICAgaWYgKHByb3h5U3RyLnN0YXJ0c1dpdGgoJ2h0dHA6Ly8nKSB8fCBwcm94eVN0ci5zdGFydHNXaXRoKCdodHRwczovLycpKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgdXJsID0gbmV3IFVSTChwcm94eVN0cik7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICB0eXBlOiAnaHR0cCcsCiAgICAgICAgICAgICAgICBob3N0OiB1cmwuaG9zdG5hbWUsCiAgICAgICAgICAgICAgICBwb3J0OiBwYXJzZUludCh1cmwucG9ydCkgfHwgKHByb3h5U3RyLnN0YXJ0c1dpdGgoJ2h0dHBzOi8vJykgPyA0NDMgOiA4MCksCiAgICAgICAgICAgICAgICB1c2VybmFtZTogdXJsLnVzZXJuYW1lID8gZGVjb2RlVVJJQ29tcG9uZW50KHVybC51c2VybmFtZSkgOiAnJywKICAgICAgICAgICAgICAgIHBhc3N3b3JkOiB1cmwucGFzc3dvcmQgPyBkZWNvZGVVUklDb21wb25lbnQodXJsLnBhc3N3b3JkKSA6ICcnCiAgICAgICAgICAgIH07CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICB9CiAgICAKICAgIGlmIChwcm94eVN0ci5zdGFydHNXaXRoKCdbJykpIHsKICAgICAgICBjb25zdCBjbG9zZUJyYWNrZXQgPSBwcm94eVN0ci5pbmRleE9mKCddJyk7CiAgICAgICAgaWYgKGNsb3NlQnJhY2tldCA+IDApIHsKICAgICAgICAgICAgY29uc3QgaG9zdCA9IHByb3h5U3RyLnN1YnN0cmluZygxLCBjbG9zZUJyYWNrZXQpOwogICAgICAgICAgICBjb25zdCByZXN0ID0gcHJveHlTdHIuc3Vic3RyaW5nKGNsb3NlQnJhY2tldCArIDEpOwogICAgICAgICAgICBpZiAocmVzdC5zdGFydHNXaXRoKCc6JykpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHBvcnQgPSBwYXJzZUludChyZXN0LnN1YnN0cmluZygxKSwgMTApOwogICAgICAgICAgICAgICAgaWYgKCFpc05hTihwb3J0KSAmJiBwb3J0ID4gMCAmJiBwb3J0IDw9IDY1NTM1KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsgdHlwZTogJ2RpcmVjdCcsIGhvc3QsIHBvcnQgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4geyB0eXBlOiAnZGlyZWN0JywgaG9zdCwgcG9ydDogNDQzIH07CiAgICAgICAgfQogICAgfQogICAgCiAgICBjb25zdCBsYXN0Q29sb25JbmRleCA9IHByb3h5U3RyLmxhc3RJbmRleE9mKCc6Jyk7CiAgICAKICAgIGlmIChsYXN0Q29sb25JbmRleCA+IDApIHsKICAgICAgICBjb25zdCBob3N0ID0gcHJveHlTdHIuc3Vic3RyaW5nKDAsIGxhc3RDb2xvbkluZGV4KTsKICAgICAgICBjb25zdCBwb3J0U3RyID0gcHJveHlTdHIuc3Vic3RyaW5nKGxhc3RDb2xvbkluZGV4ICsgMSk7CiAgICAgICAgY29uc3QgcG9ydCA9IHBhcnNlSW50KHBvcnRTdHIsIDEwKTsKICAgICAgICAKICAgICAgICBpZiAoIWlzTmFOKHBvcnQpICYmIHBvcnQgPiAwICYmIHBvcnQgPD0gNjU1MzUpIHsKICAgICAgICAgICAgcmV0dXJuIHsgdHlwZTogJ2RpcmVjdCcsIGhvc3QsIHBvcnQgfTsKICAgICAgICB9CiAgICB9CiAgICAKICAgIHJldHVybiB7IHR5cGU6ICdkaXJlY3QnLCBob3N0OiBwcm94eVN0ciwgcG9ydDogNDQzIH07Cn0KCnJldHVybiB7CiAgICBhc3luYyBmZXRjaChyZXF1ZXN0LCBlbnYsIGN0eCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IHVybCA9IG5ldyBVUkwocmVxdWVzdC51cmwpOwogICAgICAgICAgICBjb25zdCBwYXRobmFtZSA9IHVybC5wYXRobmFtZTsKICAgICAgICAgICAgbGV0IHBhdGhQcm94eUlQID0gbnVsbDsKICAgICAgICAgICAgaWYgKHBhdGhuYW1lLnN0YXJ0c1dpdGgoJy9wcm94eWlwPScpKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHBhdGhQcm94eUlQID0gZGVjb2RlVVJJQ29tcG9uZW50KHBhdGhuYW1lLnN1YnN0cmluZyg5KSkudHJpbSgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIC8vIOW/veeVpemUmeivrwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChwYXRoUHJveHlJUCAmJiAhcmVxdWVzdC5oZWFkZXJzLmdldCgnVXBncmFkZScpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJveHlJUCA9IHBhdGhQcm94eUlQOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUmVzcG9uc2UoYHNldCBwcm94eUlQIHRvOiAke3Byb3h5SVB9XG5cbmAsIHsKICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyczogeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAndGV4dC9wbGFpbjsgY2hhcnNldD11dGYtOCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnQ2FjaGUtQ29udHJvbCc6ICduby1zdG9yZSwgbm8tY2FjaGUsIG11c3QtcmV2YWxpZGF0ZSwgbWF4LWFnZT0wJywKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHJlcXVlc3QuaGVhZGVycy5nZXQoJ1VwZ3JhZGUnKSA9PT0gJ3dlYnNvY2tldCcpIHsKICAgICAgICAgICAgICAgIGxldCB3c1BhdGhQcm94eUlQID0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChwYXRobmFtZS5zdGFydHNXaXRoKCcvcHJveHlpcD0nKSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdzUGF0aFByb3h5SVAgPSBkZWNvZGVVUklDb21wb25lbnQocGF0aG5hbWUuc3Vic3RyaW5nKDkpKS50cmltKCk7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyDlv73nlaXplJnor68KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGN1c3RvbVByb3h5SVAgPSB3c1BhdGhQcm94eUlQIHx8IHVybC5zZWFyY2hQYXJhbXMuZ2V0KCdwcm94eWlwJykgfHwgcmVxdWVzdC5oZWFkZXJzLmdldCgncHJveHlpcCcpOwogICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGhhbmRsZVZsc1JlcXVlc3QocmVxdWVzdCwgY3VzdG9tUHJveHlJUCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVxdWVzdC5tZXRob2QgPT09ICdHRVQnKSB7CiAgICAgICAgICAgICAgICBpZiAodXJsLnBhdGhuYW1lID09PSAnLycpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGFuZGxlSG9tZVBhZ2UocmVxdWVzdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh1cmwucGF0aG5hbWUgPT09IGAvJHt5b3VyVVVJRH1gKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZVN1YnRpb25QYWdlKHJlcXVlc3QpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgIGlmICh1cmwucGF0aG5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhgL3N1Yi8ke3lvdXJVVUlEfWApKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY3VycmVudERvbWFpbiA9IHVybC5ob3N0bmFtZTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBoZWFkZXIgPSAndicgKyAnbCcgKyAnZScgKyAncycgKyAncyc7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgbm9kZUxpbmtzID0gY2ZpcC5tYXAoY2RuSXRlbSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBob3N0LCBwb3J0ID0gNDQzLCBub2RlTmFtZSA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2RuSXRlbS5pbmNsdWRlcygnIycpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXJ0cyA9IGNkbkl0ZW0uc3BsaXQoJyMnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNkbkl0ZW0gPSBwYXJ0c1swXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVOYW1lID0gcGFydHNbMV07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjZG5JdGVtLnN0YXJ0c1dpdGgoJ1snKSAmJiBjZG5JdGVtLmluY2x1ZGVzKCddOicpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpcHY2RW5kID0gY2RuSXRlbS5pbmRleE9mKCddOicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaG9zdCA9IGNkbkl0ZW0uc3Vic3RyaW5nKDAsIGlwdjZFbmQgKyAxKTsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwb3J0U3RyID0gY2RuSXRlbS5zdWJzdHJpbmcoaXB2NkVuZCArIDIpOyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvcnQgPSBwYXJzZUludChwb3J0U3RyKSB8fCA0NDM7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2RuSXRlbS5pbmNsdWRlcygnOicpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXJ0cyA9IGNkbkl0ZW0uc3BsaXQoJzonKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhvc3QgPSBwYXJ0c1swXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvcnQgPSBwYXJzZUludChwYXJ0c1sxXSkgfHwgNDQzOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaG9zdCA9IGNkbkl0ZW07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbm9kZU5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVOYW1lID0gYFNuaXBwZXRzLSR7aGVhZGVyfWA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBgJHtoZWFkZXJ9Oi8vJHt5b3VyVVVJRH1AJHtob3N0fToke3BvcnR9P2VuY3J5cHRpb249bm9uZSZzZWN1cml0eT10bHMmc25pPSR7Y3VycmVudERvbWFpbn0mZnA9ZmlyZWZveCZhbGxvd0luc2VjdXJlPTEmdHlwZT13cyZob3N0PSR7Y3VycmVudERvbWFpbn0mcGF0aD0lMkYlM0ZlZCUzRDI1NjAjJHtub2RlTmFtZX1gOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpbmtzVGV4dCA9IG5vZGVMaW5rcy5qb2luKCdcbicpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhc2U2NENvbnRlbnQgPSBidG9hKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChsaW5rc1RleHQpKSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBSZXNwb25zZShiYXNlNjRDb250ZW50LCB7CiAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IHsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ3RleHQvcGxhaW47IGNoYXJzZXQ9dXRmLTgnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0NhY2hlLUNvbnRyb2wnOiAnbm8tc3RvcmUsIG5vLWNhY2hlLCBtdXN0LXJldmFsaWRhdGUsIG1heC1hZ2U9MCcsCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBSZXNwb25zZSgnTm90IEZvdW5kJywgeyBzdGF0dXM6IDQwNCB9KTsKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBSZXNwb25zZSgnSW50ZXJuYWwgU2VydmVyIEVycm9yJywgeyBzdGF0dXM6IDUwMCB9KTsKICAgICAgICB9CiAgICB9LAp9OwoKYXN5bmMgZnVuY3Rpb24gaGFuZGxlVmxzUmVxdWVzdChyZXF1ZXN0LCBjdXN0b21Qcm94eUlQKSB7CiAgICBjb25zdCB3c1BhaXIgPSBuZXcgV2ViU29ja2V0UGFpcigpOwogICAgY29uc3QgW2NsaWVudFNvY2ssIHNlcnZlclNvY2tdID0gT2JqZWN0LnZhbHVlcyh3c1BhaXIpOwogICAgc2VydmVyU29jay5hY2NlcHQoKTsKICAgIGxldCByZW1vdGVDb25uV3JhcHBlciA9IHsgc29ja2V0OiBudWxsIH07CiAgICBsZXQgaXNEbnNRdWVyeSA9IGZhbHNlOwogICAgY29uc3QgZWFybHlEYXRhID0gcmVxdWVzdC5oZWFkZXJzLmdldCgnc2VjLXdlYnNvY2tldC1wcm90b2NvbCcpIHx8ICcnOwogICAgY29uc3QgcmVhZGFibGUgPSBtYWtlUmVhZGFibGVTdHJlYW0oc2VydmVyU29jaywgZWFybHlEYXRhKTsKICAgIHJlYWRhYmxlLnBpcGVUbyhuZXcgV3JpdGFibGVTdHJlYW0oewogICAgICAgIGFzeW5jIHdyaXRlKGNodW5rKSB7CiAgICAgICAgICAgIGlmIChpc0Ruc1F1ZXJ5KSByZXR1cm4gYXdhaXQgZm9yd2FyZFVEUChjaHVuaywgc2VydmVyU29jaywgbnVsbCk7CiAgICAgICAgICAgIGlmIChyZW1vdGVDb25uV3JhcHBlci5zb2NrZXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHdyaXRlciA9IHJlbW90ZUNvbm5XcmFwcGVyLnNvY2tldC53cml0YWJsZS5nZXRXcml0ZXIoKTsKICAgICAgICAgICAgICAgIGF3YWl0IHdyaXRlci53cml0ZShjaHVuayk7CiAgICAgICAgICAgICAgICB3cml0ZXIucmVsZWFzZUxvY2soKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCB7IGhhc0Vycm9yLCBtZXNzYWdlLCBhZGRyZXNzVHlwZSwgcG9ydCwgaG9zdG5hbWUsIHJhd0luZGV4LCB2ZXJzaW9uLCBpc1VEUCB9ID0gcGFyc2VXc1BhY2tldEhlYWRlcihjaHVuaywgeW91clVVSUQpOwogICAgICAgICAgICBpZiAoaGFzRXJyb3IpIHRocm93IG5ldyBFcnJvcihtZXNzYWdlKTsKCiAgICAgICAgICAgIGlmIChpc1NwZWVkVGVzdFNpdGUoaG9zdG5hbWUpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NwZWVkdGVzdCBzaXRlIGlzIGJsb2NrZWQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGlzVURQKSB7CiAgICAgICAgICAgICAgICBpZiAocG9ydCA9PT0gNTMpIGlzRG5zUXVlcnkgPSB0cnVlOwogICAgICAgICAgICAgICAgZWxzZSB0aHJvdyBuZXcgRXJyb3IoJ1VEUCBpcyBub3Qgc3VwcG9ydGVkJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgcmVzcEhlYWRlciA9IG5ldyBVaW50OEFycmF5KFt2ZXJzaW9uWzBdLCAwXSk7CiAgICAgICAgICAgIGNvbnN0IHJhd0RhdGEgPSBjaHVuay5zbGljZShyYXdJbmRleCk7CiAgICAgICAgICAgIGlmIChpc0Ruc1F1ZXJ5KSByZXR1cm4gZm9yd2FyZFVEUChyYXdEYXRhLCBzZXJ2ZXJTb2NrLCByZXNwSGVhZGVyKTsKICAgICAgICAgICAgYXdhaXQgZm9yd2FyZFRDUChhZGRyZXNzVHlwZSwgaG9zdG5hbWUsIHBvcnQsIHJhd0RhdGEsIHNlcnZlclNvY2ssIHJlc3BIZWFkZXIsIHJlbW90ZUNvbm5XcmFwcGVyLCBjdXN0b21Qcm94eUlQKTsKICAgICAgICB9LAogICAgfSkpLmNhdGNoKChlcnIpID0+IHsKICAgIH0pOwoKICAgIHJldHVybiBuZXcgUmVzcG9uc2UobnVsbCwgeyBzdGF0dXM6IDEwMSwgd2ViU29ja2V0OiBjbGllbnRTb2NrIH0pOwp9Cgphc3luYyBmdW5jdGlvbiBjb25uZWN0MlNvY2tzNShwcm94eUNvbmZpZywgdGFyZ2V0SG9zdCwgdGFyZ2V0UG9ydCwgaW5pdGlhbERhdGEpIHsKICAgIGNvbnN0IHsgaG9zdCwgcG9ydCwgdXNlcm5hbWUsIHBhc3N3b3JkIH0gPSBwcm94eUNvbmZpZzsKICAgIGxldCBzb2NrZXQ7CiAgICB0cnkgewogICAgICAgIHNvY2tldCA9IGNvbm5lY3QoeyBob3N0bmFtZTogaG9zdCwgcG9ydDogcG9ydCB9KTsKICAgICAgICBjb25zdCB3cml0ZXIgPSBzb2NrZXQud3JpdGFibGUuZ2V0V3JpdGVyKCk7CiAgICAgICAgY29uc3QgcmVhZGVyID0gc29ja2V0LnJlYWRhYmxlLmdldFJlYWRlcigpOwogICAgICAgIAogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IGF1dGhNZXRob2RzID0gdXNlcm5hbWUgJiYgcGFzc3dvcmQgPyAKICAgICAgICAgICAgICAgIG5ldyBVaW50OEFycmF5KFsweDA1LCAweDAyLCAweDAwLCAweDAyXSkgOgogICAgICAgICAgICAgICAgbmV3IFVpbnQ4QXJyYXkoWzB4MDUsIDB4MDEsIDB4MDBdKTsgCiAgICAgICAgICAgIAogICAgICAgICAgICBhd2FpdCB3cml0ZXIud3JpdGUoYXV0aE1ldGhvZHMpOwogICAgICAgICAgICBjb25zdCBtZXRob2RSZXNwb25zZSA9IGF3YWl0IHJlYWRlci5yZWFkKCk7CiAgICAgICAgICAgIGlmIChtZXRob2RSZXNwb25zZS5kb25lIHx8IG1ldGhvZFJlc3BvbnNlLnZhbHVlLmJ5dGVMZW5ndGggPCAyKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1M1IG1ldGhvZCBzZWxlY3Rpb24gZmFpbGVkJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkTWV0aG9kID0gbmV3IFVpbnQ4QXJyYXkobWV0aG9kUmVzcG9uc2UudmFsdWUpWzFdOwogICAgICAgICAgICBpZiAoc2VsZWN0ZWRNZXRob2QgPT09IDB4MDIpIHsKICAgICAgICAgICAgICAgIGlmICghdXNlcm5hbWUgfHwgIXBhc3N3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdTNSByZXF1aXJlcyBhdXRoZW50aWNhdGlvbicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB1c2VyQnl0ZXMgPSBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUodXNlcm5hbWUpOwogICAgICAgICAgICAgICAgY29uc3QgcGFzc0J5dGVzID0gbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKHBhc3N3b3JkKTsKICAgICAgICAgICAgICAgIGNvbnN0IGF1dGhQYWNrZXQgPSBuZXcgVWludDhBcnJheSgzICsgdXNlckJ5dGVzLmxlbmd0aCArIHBhc3NCeXRlcy5sZW5ndGgpOwogICAgICAgICAgICAgICAgYXV0aFBhY2tldFswXSA9IDB4MDE7IAogICAgICAgICAgICAgICAgYXV0aFBhY2tldFsxXSA9IHVzZXJCeXRlcy5sZW5ndGg7CiAgICAgICAgICAgICAgICBhdXRoUGFja2V0LnNldCh1c2VyQnl0ZXMsIDIpOwogICAgICAgICAgICAgICAgYXV0aFBhY2tldFsyICsgdXNlckJ5dGVzLmxlbmd0aF0gPSBwYXNzQnl0ZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgYXV0aFBhY2tldC5zZXQocGFzc0J5dGVzLCAzICsgdXNlckJ5dGVzLmxlbmd0aCk7CiAgICAgICAgICAgICAgICBhd2FpdCB3cml0ZXIud3JpdGUoYXV0aFBhY2tldCk7CiAgICAgICAgICAgICAgICBjb25zdCBhdXRoUmVzcG9uc2UgPSBhd2FpdCByZWFkZXIucmVhZCgpOwogICAgICAgICAgICAgICAgaWYgKGF1dGhSZXNwb25zZS5kb25lIHx8IG5ldyBVaW50OEFycmF5KGF1dGhSZXNwb25zZS52YWx1ZSlbMV0gIT09IDB4MDApIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1M1IGF1dGhlbnRpY2F0aW9uIGZhaWxlZCcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHNlbGVjdGVkTWV0aG9kICE9PSAweDAwKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFM1IHVuc3VwcG9ydGVkIGF1dGggbWV0aG9kOiAke3NlbGVjdGVkTWV0aG9kfWApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBob3N0Qnl0ZXMgPSBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUodGFyZ2V0SG9zdCk7CiAgICAgICAgICAgIGNvbnN0IGNvbm5lY3RQYWNrZXQgPSBuZXcgVWludDhBcnJheSg3ICsgaG9zdEJ5dGVzLmxlbmd0aCk7CiAgICAgICAgICAgIGNvbm5lY3RQYWNrZXRbMF0gPSAweDA1OwogICAgICAgICAgICBjb25uZWN0UGFja2V0WzFdID0gMHgwMTsKICAgICAgICAgICAgY29ubmVjdFBhY2tldFsyXSA9IDB4MDA7IAogICAgICAgICAgICBjb25uZWN0UGFja2V0WzNdID0gMHgwMzsgCiAgICAgICAgICAgIGNvbm5lY3RQYWNrZXRbNF0gPSBob3N0Qnl0ZXMubGVuZ3RoOwogICAgICAgICAgICBjb25uZWN0UGFja2V0LnNldChob3N0Qnl0ZXMsIDUpOwogICAgICAgICAgICBuZXcgRGF0YVZpZXcoY29ubmVjdFBhY2tldC5idWZmZXIpLnNldFVpbnQxNig1ICsgaG9zdEJ5dGVzLmxlbmd0aCwgdGFyZ2V0UG9ydCwgZmFsc2UpOwogICAgICAgICAgICBhd2FpdCB3cml0ZXIud3JpdGUoY29ubmVjdFBhY2tldCk7CiAgICAgICAgICAgIGNvbnN0IGNvbm5lY3RSZXNwb25zZSA9IGF3YWl0IHJlYWRlci5yZWFkKCk7CiAgICAgICAgICAgIGlmIChjb25uZWN0UmVzcG9uc2UuZG9uZSB8fCBuZXcgVWludDhBcnJheShjb25uZWN0UmVzcG9uc2UudmFsdWUpWzFdICE9PSAweDAwKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1M1IGNvbm5lY3Rpb24gZmFpbGVkJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGF3YWl0IHdyaXRlci53cml0ZShpbml0aWFsRGF0YSk7CiAgICAgICAgICAgIHdyaXRlci5yZWxlYXNlTG9jaygpOwogICAgICAgICAgICByZWFkZXIucmVsZWFzZUxvY2soKTsKICAgICAgICAgICAgcmV0dXJuIHNvY2tldDsKICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICB3cml0ZXIucmVsZWFzZUxvY2soKTsKICAgICAgICAgICAgcmVhZGVyLnJlbGVhc2VMb2NrKCk7CiAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgIH0KICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgaWYgKHNvY2tldCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgc29ja2V0LmNsb3NlKCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIC8vIHRocm93IGU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhyb3cgZXJyb3I7CiAgICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGNvbm5lY3QySHR0cChwcm94eUNvbmZpZywgdGFyZ2V0SG9zdCwgdGFyZ2V0UG9ydCwgaW5pdGlhbERhdGEpIHsKICAgIGNvbnN0IHsgaG9zdCwgcG9ydCwgdXNlcm5hbWUsIHBhc3N3b3JkIH0gPSBwcm94eUNvbmZpZzsKICAgIGxldCBzb2NrZXQ7CiAgICB0cnkgewogICAgICAgIHNvY2tldCA9IGNvbm5lY3QoeyBob3N0bmFtZTogaG9zdCwgcG9ydDogcG9ydCB9KTsKICAgICAgICBjb25zdCB3cml0ZXIgPSBzb2NrZXQud3JpdGFibGUuZ2V0V3JpdGVyKCk7CiAgICAgICAgY29uc3QgcmVhZGVyID0gc29ja2V0LnJlYWRhYmxlLmdldFJlYWRlcigpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGxldCBjb25uZWN0UmVxdWVzdCA9IGBDT05ORUNUICR7dGFyZ2V0SG9zdH06JHt0YXJnZXRQb3J0fSBIVFRQLzEuMVxyXG5gOwogICAgICAgICAgICBjb25uZWN0UmVxdWVzdCArPSBgSG9zdDogJHt0YXJnZXRIb3N0fToke3RhcmdldFBvcnR9XHJcbmA7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodXNlcm5hbWUgJiYgcGFzc3dvcmQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGF1dGggPSBidG9hKGAke3VzZXJuYW1lfToke3Bhc3N3b3JkfWApOwogICAgICAgICAgICAgICAgY29ubmVjdFJlcXVlc3QgKz0gYFByb3h5LUF1dGhvcml6YXRpb246IEJhc2ljICR7YXV0aH1cclxuYDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29ubmVjdFJlcXVlc3QgKz0gYFVzZXItQWdlbnQ6IE1vemlsbGEvNS4wXHJcbmA7CiAgICAgICAgICAgIGNvbm5lY3RSZXF1ZXN0ICs9IGBDb25uZWN0aW9uOiBrZWVwLWFsaXZlXHJcbmA7CiAgICAgICAgICAgIGNvbm5lY3RSZXF1ZXN0ICs9ICdcclxuJzsKICAgICAgICAgICAgYXdhaXQgd3JpdGVyLndyaXRlKG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZShjb25uZWN0UmVxdWVzdCkpOwogICAgICAgICAgICBsZXQgcmVzcG9uc2VCdWZmZXIgPSBuZXcgVWludDhBcnJheSgwKTsKICAgICAgICAgICAgbGV0IGhlYWRlckVuZEluZGV4ID0gLTE7CiAgICAgICAgICAgIGxldCBieXRlc1JlYWQgPSAwOwogICAgICAgICAgICBjb25zdCBtYXhIZWFkZXJTaXplID0gODE5MjsKICAgICAgICAgICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgY29uc3QgdGltZW91dE1zID0gMTAwMDA7IAogICAgICAgICAgICAKICAgICAgICAgICAgd2hpbGUgKGhlYWRlckVuZEluZGV4ID09PSAtMSAmJiBieXRlc1JlYWQgPCBtYXhIZWFkZXJTaXplKSB7CiAgICAgICAgICAgICAgICBpZiAoRGF0ZS5ub3coKSAtIHN0YXJ0VGltZSA+IHRpbWVvdXRNcykgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignY29ubmVjdGlvbiB0aW1lb3V0Jyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHsgZG9uZSwgdmFsdWUgfSA9IGF3YWl0IHJlYWRlci5yZWFkKCk7CiAgICAgICAgICAgICAgICBpZiAoZG9uZSkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ29ubmVjdGlvbiBjbG9zZWQgYmVmb3JlIHJlY2VpdmluZyBIVFRQIHJlc3BvbnNlJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IG5ld0J1ZmZlciA9IG5ldyBVaW50OEFycmF5KHJlc3BvbnNlQnVmZmVyLmxlbmd0aCArIHZhbHVlLmxlbmd0aCk7CiAgICAgICAgICAgICAgICBuZXdCdWZmZXIuc2V0KHJlc3BvbnNlQnVmZmVyKTsKICAgICAgICAgICAgICAgIG5ld0J1ZmZlci5zZXQodmFsdWUsIHJlc3BvbnNlQnVmZmVyLmxlbmd0aCk7CiAgICAgICAgICAgICAgICByZXNwb25zZUJ1ZmZlciA9IG5ld0J1ZmZlcjsKICAgICAgICAgICAgICAgIGJ5dGVzUmVhZCA9IHJlc3BvbnNlQnVmZmVyLmxlbmd0aDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXNwb25zZUJ1ZmZlci5sZW5ndGggLSAzOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2VCdWZmZXJbaV0gPT09IDB4MGQgJiYgcmVzcG9uc2VCdWZmZXJbaSArIDFdID09PSAweDBhICYmCiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlQnVmZmVyW2kgKyAyXSA9PT0gMHgwZCAmJiByZXNwb25zZUJ1ZmZlcltpICsgM10gPT09IDB4MGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyRW5kSW5kZXggPSBpICsgNDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaGVhZGVyRW5kSW5kZXggPT09IC0xKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgSFRUUCByZXNwb25zZSBvciByZXNwb25zZSB0b28gbGFyZ2UnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgaGVhZGVyVGV4dCA9IG5ldyBUZXh0RGVjb2RlcigpLmRlY29kZShyZXNwb25zZUJ1ZmZlci5zbGljZSgwLCBoZWFkZXJFbmRJbmRleCkpOwogICAgICAgICAgICBjb25zdCBzdGF0dXNMaW5lID0gaGVhZGVyVGV4dC5zcGxpdCgnXHJcbicpWzBdOwogICAgICAgICAgICBjb25zdCBzdGF0dXNNYXRjaCA9IHN0YXR1c0xpbmUubWF0Y2goL0hUVFBcL1xkXC5cZFxzKyhcZCspLyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIXN0YXR1c01hdGNoKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgcmVzcG9uc2U6ICR7c3RhdHVzTGluZX1gKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3Qgc3RhdHVzQ29kZSA9IHBhcnNlSW50KHN0YXR1c01hdGNoWzFdKTsKICAgICAgICAgICAgaWYgKHN0YXR1c0NvZGUgPCAyMDAgfHwgc3RhdHVzQ29kZSA+PSAzMDApIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ29ubmVjdGlvbiBmYWlsZWQgd2l0aCBzdGF0dXMgJHtzdGF0dXNDb2RlfTogJHtzdGF0dXNMaW5lfWApOwogICAgICAgICAgICB9CiAgICAgICAgCiAgICAgICAgICAgIGF3YWl0IHdyaXRlci53cml0ZShpbml0aWFsRGF0YSk7CiAgICAgICAgICAgIHdyaXRlci5yZWxlYXNlTG9jaygpOwogICAgICAgICAgICByZWFkZXIucmVsZWFzZUxvY2soKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBzb2NrZXQ7CiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgdHJ5IHsgCiAgICAgICAgICAgICAgICB3cml0ZXIucmVsZWFzZUxvY2soKTsgCiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgICAgIHRyeSB7IAogICAgICAgICAgICAgICAgcmVhZGVyLnJlbGVhc2VMb2NrKCk7IAogICAgICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIC8vIOehruS/neWll+aOpeWtl+iiq+ato+ehruWFs+mXrQogICAgICAgIGlmIChzb2NrZXQpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHNvY2tldC5jbG9zZSgpOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAvLyDlv73nlaXlhbPpl63plJnor68KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aHJvdyBlcnJvcjsKICAgIH0KfQoKYXN5bmMgZnVuY3Rpb24gZm9yd2FyZFRDUChhZGRyVHlwZSwgaG9zdCwgcG9ydE51bSwgcmF3RGF0YSwgd3MsIHJlc3BIZWFkZXIsIHJlbW90ZUNvbm5XcmFwcGVyLCBjdXN0b21Qcm94eUlQKSB7CiAgICBhc3luYyBmdW5jdGlvbiBjb25uZWN0RGlyZWN0KGFkZHJlc3MsIHBvcnQsIGRhdGEpIHsKICAgICAgICBjb25zdCByZW1vdGVTb2NrID0gY29ubmVjdCh7IGhvc3RuYW1lOiBhZGRyZXNzLCBwb3J0OiBwb3J0IH0pOwogICAgICAgIGNvbnN0IHdyaXRlciA9IHJlbW90ZVNvY2sud3JpdGFibGUuZ2V0V3JpdGVyKCk7CiAgICAgICAgYXdhaXQgd3JpdGVyLndyaXRlKGRhdGEpOwogICAgICAgIHdyaXRlci5yZWxlYXNlTG9jaygpOwogICAgICAgIHJldHVybiByZW1vdGVTb2NrOwogICAgfQogICAgCiAgICBsZXQgcHJveHlDb25maWcgPSBudWxsOwogICAgbGV0IHNob3VsZFVzZVByb3h5ID0gZmFsc2U7CiAgICBpZiAoY3VzdG9tUHJveHlJUCkgewogICAgICAgIHByb3h5Q29uZmlnID0gcGFyc2VQcm94eUFkZHJlc3MoY3VzdG9tUHJveHlJUCk7CiAgICAgICAgaWYgKHByb3h5Q29uZmlnICYmIChwcm94eUNvbmZpZy50eXBlID09PSAnc29ja3M1JyB8fCBwcm94eUNvbmZpZy50eXBlID09PSAnaHR0cCcgfHwgcHJveHlDb25maWcudHlwZSA9PT0gJ2h0dHBzJykpIHsKICAgICAgICAgICAgc2hvdWxkVXNlUHJveHkgPSB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAoIXByb3h5Q29uZmlnKSB7CiAgICAgICAgICAgIHByb3h5Q29uZmlnID0gcGFyc2VQcm94eUFkZHJlc3MocHJveHlJUCkgfHwgeyB0eXBlOiAnZGlyZWN0JywgaG9zdDogcHJveHlJUCwgcG9ydDogNDQzIH07CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBwcm94eUNvbmZpZyA9IHBhcnNlUHJveHlBZGRyZXNzKHByb3h5SVApIHx8IHsgdHlwZTogJ2RpcmVjdCcsIGhvc3Q6IHByb3h5SVAsIHBvcnQ6IDQ0MyB9OwogICAgICAgIGlmIChwcm94eUNvbmZpZy50eXBlID09PSAnc29ja3M1JyB8fCBwcm94eUNvbmZpZy50eXBlID09PSAnaHR0cCcgfHwgcHJveHlDb25maWcudHlwZSA9PT0gJ2h0dHBzJykgewogICAgICAgICAgICBzaG91bGRVc2VQcm94eSA9IHRydWU7CiAgICAgICAgfQogICAgfQogICAgCiAgICBhc3luYyBmdW5jdGlvbiBjb25uZWN0V2l0aFByb3h5KCkgewogICAgICAgIGxldCBuZXdTb2NrZXQ7CiAgICAgICAgaWYgKHByb3h5Q29uZmlnLnR5cGUgPT09ICdzb2NrczUnKSB7CiAgICAgICAgICAgIG5ld1NvY2tldCA9IGF3YWl0IGNvbm5lY3QyU29ja3M1KHByb3h5Q29uZmlnLCBob3N0LCBwb3J0TnVtLCByYXdEYXRhKTsKICAgICAgICB9IGVsc2UgaWYgKHByb3h5Q29uZmlnLnR5cGUgPT09ICdodHRwJyB8fCBwcm94eUNvbmZpZy50eXBlID09PSAnaHR0cHMnKSB7CiAgICAgICAgICAgIG5ld1NvY2tldCA9IGF3YWl0IGNvbm5lY3QySHR0cChwcm94eUNvbmZpZywgaG9zdCwgcG9ydE51bSwgcmF3RGF0YSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV3U29ja2V0ID0gYXdhaXQgY29ubmVjdERpcmVjdChwcm94eUNvbmZpZy5ob3N0LCBwcm94eUNvbmZpZy5wb3J0LCByYXdEYXRhKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmVtb3RlQ29ubldyYXBwZXIuc29ja2V0ID0gbmV3U29ja2V0OwogICAgICAgIG5ld1NvY2tldC5jbG9zZWQuY2F0Y2goKCkgPT4ge30pLmZpbmFsbHkoKCkgPT4gY2xvc2VTb2NrZXRRdWlldGx5KHdzKSk7CiAgICAgICAgY29ubmVjdFN0cmVhbXMobmV3U29ja2V0LCB3cywgcmVzcEhlYWRlciwgbnVsbCk7CiAgICB9CiAgICAKICAgIGlmIChzaG91bGRVc2VQcm94eSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF3YWl0IGNvbm5lY3RXaXRoUHJveHkoKTsKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgaW5pdGlhbFNvY2tldCA9IGF3YWl0IGNvbm5lY3REaXJlY3QoaG9zdCwgcG9ydE51bSwgcmF3RGF0YSk7CiAgICAgICAgICAgIHJlbW90ZUNvbm5XcmFwcGVyLnNvY2tldCA9IGluaXRpYWxTb2NrZXQ7CiAgICAgICAgICAgIGNvbm5lY3RTdHJlYW1zKGluaXRpYWxTb2NrZXQsIHdzLCByZXNwSGVhZGVyLCBjb25uZWN0V2l0aFByb3h5KTsKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgYXdhaXQgY29ubmVjdFdpdGhQcm94eSgpOwogICAgICAgIH0KICAgIH0KfQoKZnVuY3Rpb24gcGFyc2VXc1BhY2tldEhlYWRlcihjaHVuaywgdG9rZW4pIHsKICAgIGlmIChjaHVuay5ieXRlTGVuZ3RoIDwgMjQpIHJldHVybiB7IGhhc0Vycm9yOiB0cnVlLCBtZXNzYWdlOiAnSW52YWxpZCBkYXRhJyB9OwogICAgY29uc3QgdmVyc2lvbiA9IG5ldyBVaW50OEFycmF5KGNodW5rLnNsaWNlKDAsIDEpKTsKICAgIGlmIChmb3JtYXRJZGVudGlmaWVyKG5ldyBVaW50OEFycmF5KGNodW5rLnNsaWNlKDEsIDE3KSkpICE9PSB0b2tlbikgcmV0dXJuIHsgaGFzRXJyb3I6IHRydWUsIG1lc3NhZ2U6ICdJbnZhbGlkIHV1aWQnIH07CiAgICBjb25zdCBvcHRMZW4gPSBuZXcgVWludDhBcnJheShjaHVuay5zbGljZSgxNywgMTgpKVswXTsKICAgIGNvbnN0IGNtZCA9IG5ldyBVaW50OEFycmF5KGNodW5rLnNsaWNlKDE4ICsgb3B0TGVuLCAxOSArIG9wdExlbikpWzBdOwogICAgbGV0IGlzVURQID0gZmFsc2U7CiAgICBpZiAoY21kID09PSAxKSB7fSBlbHNlIGlmIChjbWQgPT09IDIpIHsgaXNVRFAgPSB0cnVlOyB9IGVsc2UgeyByZXR1cm4geyBoYXNFcnJvcjogdHJ1ZSwgbWVzc2FnZTogJ0ludmFsaWQgY21kJyB9OyB9CiAgICBjb25zdCBwb3J0SWR4ID0gMTkgKyBvcHRMZW47CiAgICBjb25zdCBwb3J0ID0gbmV3IERhdGFWaWV3KGNodW5rLnNsaWNlKHBvcnRJZHgsIHBvcnRJZHggKyAyKSkuZ2V0VWludDE2KDApOwogICAgbGV0IGFkZHJJZHggPSBwb3J0SWR4ICsgMiwgYWRkckxlbiA9IDAsIGFkZHJWYWxJZHggPSBhZGRySWR4ICsgMSwgaG9zdG5hbWUgPSAnJzsKICAgIGNvbnN0IGFkZHJlc3NUeXBlID0gbmV3IFVpbnQ4QXJyYXkoY2h1bmsuc2xpY2UoYWRkcklkeCwgYWRkclZhbElkeCkpWzBdOwogICAgc3dpdGNoIChhZGRyZXNzVHlwZSkgewogICAgICAgIGNhc2UgMTogCiAgICAgICAgICAgIGFkZHJMZW4gPSA0OyAKICAgICAgICAgICAgaG9zdG5hbWUgPSBuZXcgVWludDhBcnJheShjaHVuay5zbGljZShhZGRyVmFsSWR4LCBhZGRyVmFsSWR4ICsgYWRkckxlbikpLmpvaW4oJy4nKTsgCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMjogCiAgICAgICAgICAgIGFkZHJMZW4gPSBuZXcgVWludDhBcnJheShjaHVuay5zbGljZShhZGRyVmFsSWR4LCBhZGRyVmFsSWR4ICsgMSkpWzBdOyAKICAgICAgICAgICAgYWRkclZhbElkeCArPSAxOyAKICAgICAgICAgICAgaG9zdG5hbWUgPSBuZXcgVGV4dERlY29kZXIoKS5kZWNvZGUoY2h1bmsuc2xpY2UoYWRkclZhbElkeCwgYWRkclZhbElkeCArIGFkZHJMZW4pKTsgCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMzogCiAgICAgICAgICAgIGFkZHJMZW4gPSAxNjsgCiAgICAgICAgICAgIGNvbnN0IGlwdjYgPSBbXTsgCiAgICAgICAgICAgIGNvbnN0IGlwdjZWaWV3ID0gbmV3IERhdGFWaWV3KGNodW5rLnNsaWNlKGFkZHJWYWxJZHgsIGFkZHJWYWxJZHggKyBhZGRyTGVuKSk7IAogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDg7IGkrKykgaXB2Ni5wdXNoKGlwdjZWaWV3LmdldFVpbnQxNihpICogMikudG9TdHJpbmcoMTYpKTsgCiAgICAgICAgICAgIGhvc3RuYW1lID0gaXB2Ni5qb2luKCc6Jyk7IAogICAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OiAKICAgICAgICAgICAgcmV0dXJuIHsgaGFzRXJyb3I6IHRydWUsIG1lc3NhZ2U6IGBJbnZhbGlkIGFkZHJlc3MgdHlwZTogJHthZGRyZXNzVHlwZX1gIH07CiAgICB9CiAgICBpZiAoIWhvc3RuYW1lKSByZXR1cm4geyBoYXNFcnJvcjogdHJ1ZSwgbWVzc2FnZTogYEludmFsaWQgYWRkcmVzczogJHthZGRyZXNzVHlwZX1gIH07CiAgICByZXR1cm4geyBoYXNFcnJvcjogZmFsc2UsIGFkZHJlc3NUeXBlLCBwb3J0LCBob3N0bmFtZSwgaXNVRFAsIHJhd0luZGV4OiBhZGRyVmFsSWR4ICsgYWRkckxlbiwgdmVyc2lvbiB9Owp9CgpmdW5jdGlvbiBtYWtlUmVhZGFibGVTdHJlYW0oc29ja2V0LCBlYXJseURhdGFIZWFkZXIpIHsKICAgIGxldCBjYW5jZWxsZWQgPSBmYWxzZTsKICAgIHJldHVybiBuZXcgUmVhZGFibGVTdHJlYW0oewogICAgICAgIHN0YXJ0KGNvbnRyb2xsZXIpIHsKICAgICAgICAgICAgc29ja2V0LmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCAoZXZlbnQpID0+IHsgCiAgICAgICAgICAgICAgICBpZiAoIWNhbmNlbGxlZCkgY29udHJvbGxlci5lbnF1ZXVlKGV2ZW50LmRhdGEpOyAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHNvY2tldC5hZGRFdmVudExpc3RlbmVyKCdjbG9zZScsICgpID0+IHsgCiAgICAgICAgICAgICAgICBpZiAoIWNhbmNlbGxlZCkgeyAKICAgICAgICAgICAgICAgICAgICBjbG9zZVNvY2tldFF1aWV0bHkoc29ja2V0KTsgCiAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlci5jbG9zZSgpOyAKICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzb2NrZXQuYWRkRXZlbnRMaXN0ZW5lcignZXJyb3InLCAoZXJyKSA9PiBjb250cm9sbGVyLmVycm9yKGVycikpOwogICAgICAgICAgICBjb25zdCB7IGVhcmx5RGF0YSwgZXJyb3IgfSA9IGJhc2U2NFRvQXJyYXkoZWFybHlEYXRhSGVhZGVyKTsKICAgICAgICAgICAgaWYgKGVycm9yKSBjb250cm9sbGVyLmVycm9yKGVycm9yKTsgCiAgICAgICAgICAgIGVsc2UgaWYgKGVhcmx5RGF0YSkgY29udHJvbGxlci5lbnF1ZXVlKGVhcmx5RGF0YSk7CiAgICAgICAgfSwKICAgICAgICBjYW5jZWwoKSB7IAogICAgICAgICAgICBjYW5jZWxsZWQgPSB0cnVlOyAKICAgICAgICAgICAgY2xvc2VTb2NrZXRRdWlldGx5KHNvY2tldCk7IAogICAgICAgIH0KICAgIH0pOwp9Cgphc3luYyBmdW5jdGlvbiBjb25uZWN0U3RyZWFtcyhyZW1vdGVTb2NrZXQsIHdlYlNvY2tldCwgaGVhZGVyRGF0YSwgcmV0cnlGdW5jKSB7CiAgICBsZXQgaGVhZGVyID0gaGVhZGVyRGF0YSwgaGFzRGF0YSA9IGZhbHNlOwogICAgYXdhaXQgcmVtb3RlU29ja2V0LnJlYWRhYmxlLnBpcGVUbygKICAgICAgICBuZXcgV3JpdGFibGVTdHJlYW0oewogICAgICAgICAgICBhc3luYyB3cml0ZShjaHVuaywgY29udHJvbGxlcikgewogICAgICAgICAgICAgICAgaGFzRGF0YSA9IHRydWU7CiAgICAgICAgICAgICAgICBpZiAod2ViU29ja2V0LnJlYWR5U3RhdGUgIT09IFdlYlNvY2tldC5PUEVOKSBjb250cm9sbGVyLmVycm9yKCd3cy5yZWFkeVN0YXRlIGlzIG5vdCBvcGVuJyk7CiAgICAgICAgICAgICAgICBpZiAoaGVhZGVyKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gbmV3IFVpbnQ4QXJyYXkoaGVhZGVyLmxlbmd0aCArIGNodW5rLmJ5dGVMZW5ndGgpOwogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLnNldChoZWFkZXIsIDApOwogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLnNldChjaHVuaywgaGVhZGVyLmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgd2ViU29ja2V0LnNlbmQocmVzcG9uc2UuYnVmZmVyKTsgCiAgICAgICAgICAgICAgICAgICAgaGVhZGVyID0gbnVsbDsgCiAgICAgICAgICAgICAgICB9IGVsc2UgeyAKICAgICAgICAgICAgICAgICAgICB3ZWJTb2NrZXQuc2VuZChjaHVuayk7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBhYm9ydCgpIHt9LAogICAgICAgIH0pCiAgICApLmNhdGNoKChlcnIpID0+IHsgCiAgICAgICAgY29uc29sZS5lcnJvcignU3RyZWFtIHBpcGUgZXJyb3I6JywgZXJyKTsKICAgICAgICBjbG9zZVNvY2tldFF1aWV0bHkod2ViU29ja2V0KTsgCiAgICB9KTsKICAgIGlmICghaGFzRGF0YSAmJiByZXRyeUZ1bmMpIHsKICAgICAgICBjb25zb2xlLmxvZygnTm8gZGF0YSByZWNlaXZlZCwgcmV0cnlpbmcuLi4nKTsKICAgICAgICBhd2FpdCByZXRyeUZ1bmMoKTsKICAgIH0KfQoKYXN5bmMgZnVuY3Rpb24gZm9yd2FyZFVEUCh1ZHBDaHVuaywgd2ViU29ja2V0LCByZXNwSGVhZGVyKSB7CiAgICB0cnkgewogICAgICAgIGNvbnN0IHRjcFNvY2tldCA9IGNvbm5lY3QoeyBob3N0bmFtZTogJzguOC40LjQnLCBwb3J0OiA1MyB9KTsKICAgICAgICBsZXQgdmxlc3NIZWFkZXIgPSByZXNwSGVhZGVyOwogICAgICAgIGNvbnN0IHdyaXRlciA9IHRjcFNvY2tldC53cml0YWJsZS5nZXRXcml0ZXIoKTsKICAgICAgICBhd2FpdCB3cml0ZXIud3JpdGUodWRwQ2h1bmspOwogICAgICAgIHdyaXRlci5yZWxlYXNlTG9jaygpOwogICAgICAgIGF3YWl0IHRjcFNvY2tldC5yZWFkYWJsZS5waXBlVG8obmV3IFdyaXRhYmxlU3RyZWFtKHsKICAgICAgICAgICAgYXN5bmMgd3JpdGUoY2h1bmspIHsKICAgICAgICAgICAgICAgIGlmICh3ZWJTb2NrZXQucmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0Lk9QRU4pIHsKICAgICAgICAgICAgICAgICAgICBpZiAodmxlc3NIZWFkZXIpIHsgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gbmV3IFVpbnQ4QXJyYXkodmxlc3NIZWFkZXIubGVuZ3RoICsgY2h1bmsuYnl0ZUxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLnNldCh2bGVzc0hlYWRlciwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLnNldChjaHVuaywgdmxlc3NIZWFkZXIubGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2ViU29ja2V0LnNlbmQocmVzcG9uc2UuYnVmZmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmxlc3NIZWFkZXIgPSBudWxsOyAKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgeyAKICAgICAgICAgICAgICAgICAgICAgICAgd2ViU29ja2V0LnNlbmQoY2h1bmspOyAKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgfSkpOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAvLyBjb25zb2xlLmVycm9yKCdVRFAgZm9yd2FyZCBlcnJvcjonLCBlcnJvcik7CiAgICB9Cn0=`;

function buildWorker(connect, proxyIP, yourUUID, cfip) {
    const decoded = atob(__obfuscatedPayload);
    const factory = new Function('connect', 'proxyIP', 'yourUUID', 'cfip', `return (() => {${decoded}
})();`);
    return factory(connect, proxyIP, yourUUID, cfip);
}

export default buildWorker(connect, proxyIP, yourUUID, cfip);
